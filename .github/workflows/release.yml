name: Release

on:
  release:
    types: [published]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build cards
        run: npm run build

      - name: Verify built files
        run: |
          echo "Checking for built card files..."
          ls -lh dist/
          if [ ! -f "dist/xschedule-card.js" ]; then
            echo "ERROR: xschedule-card.js not found!"
            exit 1
          fi
          if [ ! -f "dist/xschedule-playlist-browser.js" ]; then
            echo "ERROR: xschedule-playlist-browser.js not found!"
            exit 1
          fi
          echo "‚úì All card files built successfully"

      - name: Create distribution archive
        run: |
          mkdir -p release
          cp -r custom_components release/
          cp -r dist release/
          cp hacs.json release/
          cp README.md release/
          cp LICENSE release/
          cd release
          zip -r ../xschedule-homeassistant.zip .
          cd ..
          tar -czf xschedule-homeassistant.tar.gz -C release .

          # Verify archives were created
          ls -lh xschedule-homeassistant.zip xschedule-homeassistant.tar.gz

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            xschedule-homeassistant.zip
            xschedule-homeassistant.tar.gz
            dist/xschedule-card.js
            dist/xschedule-playlist-browser.js
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release body
        uses: softprops/action-gh-release@v2
        with:
          append_body: true
          body: |

            ## üì¶ Release Assets

            This release includes:
            - **xschedule-homeassistant.zip** - Complete integration + cards (for manual installation)
            - **xschedule-homeassistant.tar.gz** - Complete integration + cards (alternative format)
            - **xschedule-card.js** - Main media player card only
            - **xschedule-playlist-browser.js** - Playlist browser card only

            ## üöÄ Installation

            ### HACS (Recommended)
            1. Add this repository as a custom repository in HACS
            2. Go to HACS ‚Üí Integrations
            3. Search for "xSchedule"
            4. Click Install
            5. Restart Home Assistant
            6. Go to Settings ‚Üí Devices & Services ‚Üí Add Integration
            7. Search for "xSchedule" and configure

            ### Manual Installation
            1. Download **xschedule-homeassistant.zip**
            2. Extract to your Home Assistant config directory:
               - `custom_components/xschedule/` ‚Üí `config/custom_components/xschedule/`
               - `dist/*.js` ‚Üí `config/www/` (for Lovelace cards)
            3. Restart Home Assistant
            4. Add Lovelace resources:
               - `/local/xschedule-card.js`
               - `/local/xschedule-playlist-browser.js`
            5. Go to Settings ‚Üí Devices & Services ‚Üí Add Integration
            6. Search for "xSchedule" and configure

            ### Card-Only Installation
            If you already have the integration installed and only need to update the cards:
            1. Download **xschedule-card.js** and/or **xschedule-playlist-browser.js**
            2. Copy to `config/www/` directory
            3. Clear browser cache (Ctrl+F5 or Cmd+Shift+R)
            4. Refresh your dashboard

            ## üìù Card Modes

            The main xSchedule card supports 5 modes:
            - **Simple** (default) - Basic playback control
            - **DJ** - Live performance with expanded playlists
            - **Jukebox** - Party mode with prominent queue
            - **Minimal** - Compact for small spaces
            - **Custom** - Full control with visual editor

            See the [README](https://github.com/mr-light-show/xschedule-homeassistant#card-modes) for detailed mode descriptions.

            ## ‚ú® Features

            - üéÆ Full media player controls (play, pause, stop, next, previous, seek)
            - üì° Real-time WebSocket updates (no polling!)
            - üéµ Queue management with duplicate prevention
            - üì± Mobile-responsive design with long-press context menu
            - üé® Visual configuration editor (no YAML editing needed!)
            - üìÖ Smart playlist scheduling display
            - üîä Volume control
            - üéØ 5 preset card modes for different use cases

            ## üìö Documentation

            - [README](https://github.com/mr-light-show/xschedule-homeassistant/blob/main/README.md) - Full documentation
            - [Implementation Details](https://github.com/mr-light-show/xschedule-homeassistant/blob/main/IMPLEMENTATION_SUMMARY.md)
            - [Enhancement Details](https://github.com/mr-light-show/xschedule-homeassistant/blob/main/ENHANCEMENTS_SUMMARY.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
